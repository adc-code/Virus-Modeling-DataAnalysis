<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Page Template</title>
        <script type="text/javascript" src="d3.v5.js"></script>

        <style type="text/css">
            .lineS
            {
                fill: none;
                stroke: #0033cc;
                stroke-width: 2;
            }

            .lineE
            {
                fill: none;
                stroke: #990099;
                stroke-width: 2;
            }

            .lineI
            {
                fill: none;
                stroke: #ffab00;
                stroke-width: 2;
            }

            .lineR
            {
                fill: none;
                stroke: #009933;
                stroke-width: 2;
            }

            .lineCap
            {
                fill: none;
                stroke: #ff0000;
                stroke-width: 1;
                stroke-dasharray: 2, 3;
            }

            .container 
            {
                overflow:auto; 
            }

            .sidebyside 
            {
                float:        left; 
                margin:       1px;
                padding:      2px;
            }

            .belowdiv 
            {
                float:        bottom; 
                padding:          5px; 
                font-family:      Helvetica, sans-serif;
                font-size:        12px;
            }

            .inputDiv
            {
                background-color: #006666;
                color:            #ffffff;
                margin:           3px;
                border-radius:    5px;
                padding:          5px; 
                font-family:      Helvetica, sans-serif;
                font-size:        12px;
                width: 175px;
            }

            .sliderDiv 
            {
                padding:          5px; 
                font-family:      Helvetica, sans-serif;
                font-size:        12px;
                /*width:            150px; */
            }

            .sliderInput
            {
                width: 200px;
                height: 20px;
                padding: 10px; 
                margin:  5px;
                border-radius: 5px;
                background-color: #dddddd;
                display: inline;
                font-family: Helvetica, sans-serif;
                font-size: 12px;
            }
         
            .axisLabel
            {
                font-family: Helvetica, sans-serif;
                font-size: 12px;
            } 

        </style>

    </head>

    <body>

        <div class='container'>

            <div class='sidebyside'>

                 <div class='belowdiv inputDiv'>
                     <div class='sliderDiv'>
                         <span style='font-family:serif'>&beta;</span> - Transmission Rate: 
                     </div>
                     <input id="sliderBeta" type="range" min="0.01" max="5" step="0.01" value="0.5"/> 
                     <output id='betaValue'>0.50</output>
                 </div>
                 <div class='belowdiv inputDiv'>
                     <div class='sliderDiv'>
                         <span style='font-family:serif'>&gamma;</span> - Recovery Rate: 
                     </div>
                     <input id="sliderGamma" type="range" min="0.01" max="1" step="0.01" value="0.2"/>
                     <output id='gammaValue'>0.20</output>
                 </div>
                 <div class='belowdiv inputDiv'>
                     <div class='sliderDiv'>
                         <span style='font-family:serif'>&epsilon;<span> - Exposed to Infected Rate
                     </div>
                     <input id="sliderEps" type="range" min="0.01" max="2" step="0.01" value="0.5"/> 
                     <output id='epsilonValue'>0.50</output>
                 </div>
                 <div class='belowdiv inputDiv'>
                     <div class='sliderDiv'>
                         <span style='font-family:serif'>&alpha;</span> - Birth/Incoming Rate
                     </div>
                     <input id="sliderAlpha" type="range" min="0" max="30" step="1" value="0"/>
                     <output id='alphaValue'>0</output>
                 </div>
                 <div class='belowdiv inputDiv'>
                     <div class='sliderDiv'>
                         <span style='font-family:serif'>&mu;</span> - Natural Death Rate
                     </div>
                     <input id="sliderMu" type="range" min="0" max="30" step="1" value="0"/>
                     <output id='muValue'>0</output>
                 </div>

                 <div style='height:3px;width:60px;' > </div> 

                 <div class='belowdiv inputDiv'>
                     <div class='sliderDiv'>
                         Capacity Level
                     </div>
                     <input id="sliderCapacity" type="range" min="0" max="1" step="0.01" value="0.2"/>
                     <output id='capValue'> 20% </output>
                 </div>
                 <div class='belowdiv inputDiv'>
                     <div class='sliderDiv'>
                         Max Time
                     </div>
                     <input id='sliderTimeMax' type="range" min="20" max="180" step="5" value="50"/>
                     <output style='width:100px;' id='timeMaxValue'> 50</output>
                 </div>

            </div>

            <div class='sidebyside'>
                <div id='graph'>
                </div>
            </div>

        </div>


        <script type="text/javascript">

            // 
            // ODE Stuff...
            // 

            var timeStart  =   0;
            var timeEnd    =  50;
            var deltaT     = 0.1;

            var beta    = 0.5;
            var gamma   = 0.2;
            var epsilon = 0.5;
            var alpha   = 0; //0.005;
            var mu      = 0; //0.001;
        
            var capLevel = 0.2;

            var S_0 = 0.99;
            var E_0 = 0.01;
            var I_0 = 0.00;
            var R_0 = 0.00;

            var dSdt = function (S, E, I, R)
            {
                return  alpha  -  beta * S * I  -  mu * S;
            };

            var dEdt = function (S, E, I, R)
            {
                return  beta * S * I  -  epsilon * E  -  mu * E;
            };

            var dIdt = function (S, E, I, R)
            {
                return  epsilon * E  -  gamma * I  -  mu * I
            };

            var dRdt = function (S, E, I, R)
            {
                return  gamma * I  -  mu * R;
            };

            var ComputeValues = function (S_0, E_0, I_0, R_0, time_1, time_2)
            {
                var t_n = time_1;
                var S_n = S_0;
                var E_n = E_0;
                var I_n = I_0;
                var R_n = R_0;

                var maxValue = 0;

                // The number of datapoints
                var NumPoints  = Math.ceil ( (time_2 - time_1) / deltaT );

                var Results   = [];
                Results.push ( {'t': time_1, 'S': S_0, 'E': E_0, 'I': I_0, 'R': R_0} );

                for (var i = 0; i < NumPoints; i++)
                {
                    var k1 = deltaT * dSdt (S_n, E_n, I_n, R_n);
                    var l1 = deltaT * dEdt (S_n, E_n, I_n, R_n);
                    var m1 = deltaT * dIdt (S_n, E_n, I_n, R_n);
                    var n1 = deltaT * dRdt (S_n, E_n, I_n, R_n);

                    var k2 = deltaT * dSdt (S_n + 0.5*k1, E_n + 0.5*l1, I_n + 0.5*m1, R_n + 0.5*n1);
                    var l2 = deltaT * dEdt (S_n + 0.5*k1, E_n + 0.5*l1, I_n + 0.5*m1, R_n + 0.5*n1);
                    var m2 = deltaT * dIdt (S_n + 0.5*k1, E_n + 0.5*l1, I_n + 0.5*m1, R_n + 0.5*n1);
                    var n2 = deltaT * dRdt (S_n + 0.5*k1, E_n + 0.5*l1, I_n + 0.5*m1, R_n + 0.5*n1);

                    var k3 = deltaT * dSdt (S_n + 0.5*k2, E_n + 0.5*l2, I_n + 0.5*m2, R_n + 0.5*n2);
                    var l3 = deltaT * dEdt (S_n + 0.5*k2, E_n + 0.5*l2, I_n + 0.5*m2, R_n + 0.5*n2);
                    var m3 = deltaT * dIdt (S_n + 0.5*k2, E_n + 0.5*l2, I_n + 0.5*m2, R_n + 0.5*n2);
                    var n3 = deltaT * dRdt (S_n + 0.5*k2, E_n + 0.5*l2, I_n + 0.5*m2, R_n + 0.5*n2);

                    var k4 = deltaT * dSdt (S_n + k3, E_n + l3, I_n + m3, R_n + n3);
                    var l4 = deltaT * dEdt (S_n + k3, E_n + l3, I_n + m3, R_n + n3);
                    var m4 = deltaT * dIdt (S_n + k3, E_n + l3, I_n + m3, R_n + n3);
                    var n4 = deltaT * dRdt (S_n + k3, E_n + l3, I_n + m3, R_n + n3);

                    S_n = S_n + 1/6 * (k1 + 2*k2 + 2*k3 + k4);
                    E_n = E_n + 1/6 * (l1 + 2*l2 + 2*l3 + l4);
                    I_n = I_n + 1/6 * (m1 + 2*m2 + 2*m3 + m4);
                    R_n = R_n + 1/6 * (n1 + 2*n2 + 2*n3 + n4);

                    t_n = t_n + deltaT;

                    var tmpMax = d3.max ( [S_n, E_n, I_n, R_n] );
                    if (tmpMax > maxValue)
                       maxValue = tmpMax;

                    //console.log (maxValue);

                    Results.push ( { 't': t_n, 'S': S_n, 'E': E_n, 'I': I_n, 'R': R_n } );
                }

                return { 'data': Results, 'maxValue': maxValue };

            }; // function ComputeValues

            //
            // D3 Stuff...
            //
            var margin = { top: 10, right: 45, bottom: 60, left: 70 };
            var width  = 0.75 * window.innerWidth  - margin.left - margin.right;
            var height = 0.75 * window.innerHeight - margin.top  - margin.bottom; 

            // X scale will use the index of our data
            var xScale = d3.scaleLinear ()
                           .domain ([timeStart, timeEnd])   // input
                           .range ([0, width]);             // output

            // Y scale will use the randomly generate number 
            var yScale = d3.scaleLinear ()
                           .domain ([0, 1])                 // input 
                           .range ([height, 0]);            // output 

            var lineS = d3.line ()
                          .x (function (d)    {  return xScale (d.t);  })    
                          .y (function (d)    {  return yScale (d.S);  })   
                          .curve (d3.curveMonotoneX) 

            var lineE = d3.line ()
                          .x (function (d)    {  return xScale (d.t);  })    
                          .y (function (d)    {  return yScale (d.E);  })   
                          .curve (d3.curveMonotoneX) 

            var lineI = d3.line ()
                          .x (function (d)    {  return xScale (d.t);  })    
                          .y (function (d)    {  return yScale (d.I);  })   
                          .curve (d3.curveMonotoneX) 

            var lineR = d3.line ()
                          .x (function (d)    {  return xScale (d.t);  })   
                          .y (function (d)    {  return yScale (d.R);  })  
                          .curve (d3.curveMonotoneX) 

            var lineCap = d3.line ()
                            .x (function (d)    {  return xScale (d.t);  })   
                            .y (function (d)    {  return yScale (d.y);  })  

            var dataset = ComputeValues (S_0, E_0, I_0, R_0, timeStart, timeEnd);

            var svg = d3.select ('div#graph')
                        .append ('svg')
                        .attr ('width', width + margin.left + margin.right)
                        .attr ('height', height + margin.top + margin.bottom)
                        .append ('g')
                        .attr ('transform', 'translate(' + margin.left + ',' + margin.top + ')');

            // Define axes
            var xAxis = d3.axisBottom ()
                          .scale (xScale);

            // Define Y axis
            var yAxis = d3.axisLeft ()
                          .scale (yScale)
                          .tickFormat (d => Math.floor (100 * d) + "%");  

            // Create axes
            svg.append ('g')
               .attr ('class', 'x axis')
               .attr ('transform', 'translate(0,' + height + ')')
               .call (xAxis);

            svg.append ('g')
               .attr ('class', 'y axis')
               .attr ('transform', 'translate(' + 0 + ',0)')
               .call (yAxis); 

            svg.append ('path')
               .datum (dataset.data)         
               .attr ('class', 'lineS')
               .attr ('d', lineS);    

            svg.append ('path')
               .datum (dataset.data)         
               .attr ('class', 'lineE') 
               .attr ('d', lineE);     

            svg.append ('path')
               .datum (dataset.data)         
               .attr ('class', 'lineI') 
               .attr ('d', lineI);     

            svg.append ('path')
               .datum (dataset.data)         
               .attr ('class', 'lineR') 
               .attr ('d', lineR);     

            svg.append ('path')
               .datum ( [ {t: timeStart, y: capLevel}, {t: timeEnd, y: capLevel} ] )
               .attr ('class', 'lineCap') // Assign a class for styling 
               .attr ('d', lineCap);

            //
            // Axis labels...
            //
            svg.append ('text')
               .style ('text-anchor', 'middle')
               .attr ('transform', 'rotate(-90)')
               .attr ('x', -height * 0.5)
               .attr ('y', -margin.left * 0.66)
               .text ('Percent of Population')
               .attr ('class', 'axisLabel');

            svg.append ('text')
               .style ('text-anchor', 'left')
               .text ('Time')
               .attr ('x', xScale (timeEnd) + 0.2 * margin.right )
               .attr ('y', height + 0.2 * margin.bottom)
               .attr ('class', 'axisLabel');

            var legendLabels  = [ 'Susceptible', 'Exposed', 'Infected', 'Recovered' ];
            var legendColours = [ '#0033cc', '#990099', '#ffab00', '#009933' ];
            var legendOffset  = 15;

            for (var i = 0; i < 4; i++)
            {
                svg.append ('rect')
                   .attr ('x', xScale (legendOffset * i))
                   .attr ('y', height + 0.5 * margin.bottom)
                   .attr ('width', 10)
                   .attr ('height', 10)
                   .attr ('fill', legendColours[i]);

                svg.append ('text')
                   .style ('text-anchor', 'left')
                   .text (legendLabels[i])
                   .attr ('x', xScale (legendOffset * i) + 15)
                   .attr ('y', height + 0.5 * margin.bottom + 10)
                   .attr ('class', 'axisLabel');
            }

            var redrawGraph = function ()
            {
                  dataset = ComputeValues (S_0, E_0, I_0, R_0, timeStart, timeEnd);

                  maxValue = Math.ceil (dataset.maxValue * 10) / 10;

                  if (maxValue < 1)
                      maxValue = 1;

                  yScale.domain ([0, maxValue]);

                  // Update x-axis
                  svg.select ('.y.axis')
                     .transition ()
                     .duration (250)
                     .call (yAxis); 

                  svg.select ('.lineS').attr ('d', lineS (dataset.data));
                  svg.select ('.lineE').attr ('d', lineE (dataset.data));
                  svg.select ('.lineI').attr ('d', lineI (dataset.data));
                  svg.select ('.lineR').attr ('d', lineR (dataset.data));
            };


            // On change, update styling
            d3.select ('input#sliderBeta').on ('input', function() 
            {
                  beta = +d3.select(this).node().value;
                  betaValue.innerHTML = beta.toFixed (2);
            
                  redrawGraph ();                            
            });

            d3.select ('input#sliderGamma').on ('input', function() 
            {
                  gamma = +d3.select(this).node().value;
                  gammaValue.innerHTML = gamma.toFixed (2);
                      
                  redrawGraph ();                            
            });

            d3.select ('input#sliderEps').on ('input', function() 
            {
                  epsilon = +d3.select(this).node().value;
                  epsilonValue.innerHTML = epsilon.toFixed (2);
                      
                  redrawGraph ();                            
            });

            d3.select ('input#sliderAlpha').on ('input', function() 
            {
                  alpha = +d3.select(this).node().value / 1000;
                  alphaValue.innerHTML = (1000 * alpha).toFixed (0);

                  //console.log ('alpha = ', alpha);
                      
                  redrawGraph ();                            
            });

            d3.select ('input#sliderMu').on ('input', function() 
            {
                  mu = +d3.select(this).node().value / 1000;
                  muValue.innerHTML = (1000 * mu).toFixed (0);

                  //console.log ('mu = ', mu);
                      
                  redrawGraph ();                            
            });

            d3.select ('input#sliderCapacity').on ('input', function()
            {
                  capLevel = +d3.select(this).node().value;
                  capValue.innerHTML = ((100 * capLevel).toFixed(0)).toString() + "%";

                  // console.log (capLevel);

                  lineData = [ {t: 0, y: capLevel}, {t: timeEnd, y: capLevel} ];
                  svg.select ('.lineCap').attr ('d', lineCap(lineData));
            });

            d3.select ('input#sliderTimeMax').on ('input', function()
            {
                  timeEnd = +d3.select(this).node().value;
                  timeMaxValue.innerHTML = timeEnd;
                  xScale.domain ([timeStart, timeEnd]);
   
                  // Update x-axis
                  svg.select ('.x.axis')
                     .transition ()
                     .duration (500)
                     .call (xAxis);

                  redrawGraph ();                            
            });
                     
        </script>

    </body>

</html>



