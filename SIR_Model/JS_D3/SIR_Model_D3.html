<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>D3 Page Template</title>
        <script type="text/javascript" src="d3.v5.js"></script>

        <style type="text/css">
            .lineS
            {
                fill: none;
                stroke: #0033cc;
                stroke-width: 2;
            }

            .lineI
            {
                fill: none;
                stroke: #ffab00;
                stroke-width: 2;
            }

            .lineR
            {
                fill: none;
                stroke: #009933;
                stroke-width: 2;
            }

            .lineCap
            {
                fill: none;
                stroke: #ff0000;
                stroke-width: 1;
                stroke-dasharray: 2, 3;
            }

            .container 
            {
                overflow:auto; 
            }

            .sidebyside 
            {
                float:        left; 
                /* border-style: solid; 
                border-color: #000000;
                border-width: thin;*/
                margin:       1px;
                padding:      2px;
                /* width:20px;  */
            }

            .belowdiv 
            {
                /* border-style:  solid; 
                border-color:     #000000;
                border-width:     thin; */
                margin:           3px;
                border-radius:    5px;
                background-color: #006666;
                color:            #ffffff;
                padding:          5px; 
                font-family:      Helvetica, sans-serif;
                font-size:        12px;
            }

            .sliderDiv 
            {
                padding:          5px; 
                font-family:      Helvetica, sans-serif;
                font-size:        12px;
                /*width:            150px; */
            }

            .sliderInput
            {
                width: 200px;
                height: 20px;
                padding: 10px; 
                margin:  5px;
                border-radius: 5px;
                background-color: #dddddd;
                display: inline;
                font-family: Helvetica, sans-serif;
                font-size: 12px;
            }
         
            .axisLabel
            {
                font-family: Helvetica, sans-serif;
                font-size: 12px;
            } 

        </style>

    </head>

    <body>

        <div class="container">
             <div class='sidebyside'>
                 <div class='belowdiv'>
                     <div class='sliderDiv'>
                         <span style='font-family:serif'>&beta;</span> - Transmission Rate: 
                     </div>
                     <input id="sliderBeta" type="range" min="0" max="5" step="0.01" value="0.5"/> 
                     <output id='betaValue'>0.50</output>
                 </div>
                 <div class="belowdiv">
                     <div class='sliderDiv'>
                         <span style='font-family:serif'>&gamma;</span> - Recovery Rate: 
                     </div>
                     <input id="sliderGamma" type="range" min="0" max="1" step="0.01" value="0.2">
                     <output id='gammaValue'>0.20</output>
                 </div>
                 
                 <!--
                 <div class="belowdiv">
                     <div class='sliderDiv'>
                         Initial Infections / Susceptibles:
                     </div>
                     <input id="sliderInit" type="range" min="1" max="99" step="1" value="1" width=50px/> 
                     <output id='initialValue'> 1 / 50 % </output>
                 </div>
                 --> 

                 <div style='height:10px'> </div>

                 <div class="belowdiv">
                     <div class='sliderDiv'>
                         Capacity Level
                     </div>
                     <input id="sliderCapacity" type="range" min="0" max="1" step="0.01" value="0.2">
                     <output id='capValue'> 20% </output>
                 </div>
                 <div class="belowdiv">
                     <div class='sliderDiv'>
                         Max Time
                     </div>
                     <input id='sliderTimeMax' type="range" min="20" max="90" step="5" value="50">
                     <output id='timeMaxValue'>  50</output>
                 </div>

             </div>
             <div class="sidebyside">
                 <div id='graph' style='border-style: solid; border-width: thin;'>
                 </div>
             </div>
        </div>


        <script type="text/javascript">

            // 
            // ODE Stuff...
            // 

            var timeStart  =   0;
            var timeEnd    =  50;
            var deltaT     = 0.1;

            var beta   = 0.5;
            var gamma  = 0.2;
        
            var capLevel = 0.2;

            var t_0 = 0.00;
            var S_0 = 0.99;
            var I_0 = 0.01;
            var R_0 = 0.00;

            var dSdt = function (S, I, R) 
            {
                return -beta * S * I;
            };

            var dIdt = function (S, I, R)
            {
                return beta * S * I - gamma * I
            };

            var dRdt = function (S, I, R)
            {
                return gamma * I
            };

            var ComputeValues = function (t_0, S_0, I_0, R_0, time_1, time_2)
            {
                var t_n = t_0;
                var S_n = S_0;
                var I_n = I_0;
                var R_n = R_0;

                // The number of datapoints
                var NumPoints  = Math.ceil ( (time_2 - time_1) / deltaT );

                var times     = [t_0];
                var S_Results = [S_0]; 
                var I_Results = [I_0]; 
                var R_Results = [R_0]; 

                var Results   = [];
                Results.push ( {'t': t_0, 'S': S_0, 'I': I_0, 'R': R_0} );

                for (var i = 0; i < NumPoints; i++)
                {
                    var k1 = deltaT * dSdt (S_n, I_n, R_n);
                    var l1 = deltaT * dIdt (S_n, I_n, R_n);
                    var m1 = deltaT * dRdt (S_n, I_n, R_n);

                    var k2 = deltaT * dSdt (S_n + 0.5*k1, I_n + 0.5*l1, R_n + 0.5*m1);
                    var l2 = deltaT * dIdt (S_n + 0.5*k1, I_n + 0.5*l1, R_n + 0.5*m1);
                    var m2 = deltaT * dRdt (S_n + 0.5*k1, I_n + 0.5*l1, R_n + 0.5*m1);

                    var k3 = deltaT * dSdt (S_n + 0.5*k2, I_n + 0.5*l2, R_n + 0.5*m2);
                    var l3 = deltaT * dIdt (S_n + 0.5*k2, I_n + 0.5*l2, R_n + 0.5*m2);
                    var m3 = deltaT * dRdt (S_n + 0.5*k2, I_n + 0.5*l2, R_n + 0.5*m2);

                    var k4 = deltaT * dSdt (S_n + k3, I_n + l3, R_n + m3);
                    var l4 = deltaT * dIdt (S_n + k3, I_n + l3, R_n + m3);
                    var m4 = deltaT * dRdt (S_n + k3, I_n + l3, R_n + m3);

                    S_n = S_n + 1/6 * (k1 + 2*k2 + 2*k3 + k4);
                    I_n = I_n + 1/6 * (l1 + 2*l2 + 2*l3 + l4);
                    R_n = R_n + 1/6 * (m1 + 2*m2 + 2*m3 + m4);

                    t_n = t_n + deltaT;

                    Results.push ( { 't': t_n, 'S': S_n, 'I': I_n, 'R': R_n } );
                }

                return Results;

            }; // function ComputeValues

            //
            // D3 Stuff...
            //
            var margin = { top: 10, right: 45, bottom: 60, left: 70 };
            var width  = 0.66 * window.innerWidth  - margin.left - margin.right;
            var height = 0.66 * window.innerHeight - margin.top  - margin.bottom; 

            // X scale will use the index of our data
            var xScale = d3.scaleLinear ()
                           .domain ([timeStart, timeEnd])   // input
                           .range ([0, width]);             // output

            // Y scale will use the randomly generate number 
            var yScale = d3.scaleLinear ()
                           .domain ([0, 1])                 // input 
                           .range ([height, 0]);            // output 

            var lineS = d3.line ()
                          .x (function(d)    {  return xScale (d.t);  })     // set the x values for the line generator
                          .y (function(d)    {  return yScale (d.S);  })     // set the y values for the line generator 
                          .curve (d3.curveMonotoneX) // apply smoothing to the line

            var lineI = d3.line ()
                          .x (function(d)    {  return xScale (d.t);  })     // set the x values for the line generator
                          .y (function(d)    {  return yScale (d.I);  })     // set the y values for the line generator 
                          .curve (d3.curveMonotoneX) // apply smoothing to the line

            var lineR = d3.line ()
                          .x (function(d)    {  return xScale (d.t);  })     // set the x values for the line generator
                          .y (function(d)    {  return yScale (d.R);  })     // set the y values for the line generator 
                          .curve (d3.curveMonotoneX) // apply smoothing to the line

            var lineCap = d3.line ()
                            .x (function(d)    {  return xScale (d.t);  })     // set the x values for the line generator
                            .y (function(d)    {  return yScale (d.y);  })     // set the y values for the line generator 

            var dataset = ComputeValues (t_0, S_0, I_0, R_0, timeStart, timeEnd);

            var svg = d3.select ('div#graph')
                        .append ('svg')
                        .attr ('width', width + margin.left + margin.right)
                        .attr ('height', height + margin.top + margin.bottom)
                        .append ('g')
                        .attr ('transform', 'translate(' + margin.left + ',' + margin.top + ')');

            // Define axes
            var xAxis = d3.axisBottom ()
                          .scale (xScale);

            // Define Y axis
            var yAxis = d3.axisLeft ()
                          .scale (yScale)
                          .tickFormat (d => 100 * d + "%");  

            // Create axes
            svg.append ('g')
               .attr ('class', 'x axis')
               .attr ('transform', 'translate(0,' + height + ')')
               .call (xAxis);

            svg.append ('g')
               .attr ('class', 'y axis')
               .attr ('transform', 'translate(' + 0 + ',0)')
               .call (yAxis); 

            svg.append ('path')
               .datum (dataset)         // 10. Binds data to the line 
               .attr ('class', 'lineI') // Assign a class for styling 
               .attr ('d', lineI);      // 11. Calls the line generator

            svg.append ('path')
               .datum (dataset)         // 10. Binds data to the line 
               .attr ('class', 'lineS') // Assign a class for styling 
               .attr ('d', lineS);      // 11. Calls the line generator

            svg.append ('path')
               .datum (dataset)         // 10. Binds data to the line 
               .attr ('class', 'lineR') // Assign a class for styling 
               .attr ('d', lineR);      // 11. Calls the line generator

            svg.append ('path')
               .datum ( [ {t: timeStart, y: capLevel}, {t: timeEnd, y: capLevel} ] )
               .attr ('class', 'lineCap') // Assign a class for styling 
               .attr ('d', lineCap);

            svg.append ('text')
               .style ('text-anchor', 'middle')
               .attr ('transform', 'rotate(-90)')
               .attr ('x', -height * 0.5)
               .attr ('y', -margin.left * 0.66)
               .text ('Percent of Population')
               .attr ('class', 'axisLabel');

            svg.append ('text')
               .style ('text-anchor', 'left')
               .text ('Time')
               .attr ('x', xScale (timeEnd) + 0.2 * margin.right )
               .attr ('y', height + 0.2 * margin.bottom)
               .attr ('class', 'axisLabel');

            svg.append ('rect')
               .attr ('x', xScale (10))
               .attr ('y', height + 0.5 * margin.bottom)
               .attr ('width', 10)
               .attr ('height', 10)
               .attr ('fill', '#0033cc');

            svg.append ('text')
               .style ('text-anchor', 'left')
               .text ('Susceptible')
               .attr ('x', xScale (10) + 15)
               .attr ('y', height + 0.5 * margin.bottom + 10)
               .attr ('class', 'axisLabel');

            svg.append ('rect')
               .attr ('x', xScale (23.5))
               .attr ('y', height + 0.5 * margin.bottom)
               .attr ('width', 10)
               .attr ('height', 10)
               .attr ('fill', '#ffab00');

            svg.append ('text')
               .style ('text-anchor', 'left')
               .text ('Infected')
               .attr ('x', xScale (23.5) + 15)
               .attr ('y', height + 0.5 * margin.bottom + 10)
               .attr ('class', 'axisLabel');

            svg.append ('rect')
               .attr ('x', xScale (35))
               .attr ('y', height + 0.5 * margin.bottom)
               .attr ('width', 10)
               .attr ('height', 10)
               .attr ('fill', '#009933');

            svg.append ('text')
               .style ('text-anchor', 'left')
               .text ('Removed')
               .attr ('x', xScale (35) + 15)
               .attr ('y', height + 0.5 * margin.bottom + 10)
               .attr ('class', 'axisLabel');


            var redrawGraph = function ()
            {
                  dataset = ComputeValues (t_0, S_0, I_0, R_0, timeStart, timeEnd);

                  svg.select ('.lineI').attr ('d', lineI (dataset));
                  svg.select ('.lineS').attr ('d', lineS (dataset));
                  svg.select ('.lineR').attr ('d', lineR (dataset));
            };


            // On change, update styling
            d3.select ('input#sliderBeta').on ('input', function() 
            {
                  beta = +d3.select(this).node().value;
                  betaValue.innerHTML = beta.toFixed (2);
            
                  redrawGraph ();                            
            });

            d3.select ('input#sliderGamma').on ('input', function() 
            {
                  gamma = +d3.select(this).node().value;
                  gammaValue.innerHTML = gamma.toFixed (2);
                      
                  redrawGraph ();                            
            });

            d3.select ('input#sliderCapacity').on ('input', function()
            {
                  capLevel = +d3.select(this).node().value;
                  capValue.innerHTML = ((100 * capLevel).toFixed(0)).toString() + "%";

                  // console.log (capLevel);

                  lineData = [ {t: 0, y: capLevel}, {t: timeEnd, y: capLevel} ];
                  svg.select ('.lineCap').attr ('d', lineCap(lineData));
            });

            /* d3.select ('input#sliderInit').on ('input', function()
            {
                  initValue = +d3.select(this).node().value;

                  I_0 = initValue / 100;
                  S_0 = 1 - initValue / 100;

                  initialValue.innerHTML = initValue.toString() + ' / ' + (100 - initValue).toString() + ' %';

                  console.log (initValue);

                  dataset = ComputeValues (t_0, S_0, I_0, R_0, timeStart, timeEnd);

                  svg.select ('.lineI').attr ('d', lineI(dataset));
                  svg.select ('.lineS').attr ('d', lineS(dataset));
                  svg.select ('.lineR').attr ('d', lineR(dataset));
            }); */

            d3.select ('input#sliderTimeMax').on ('input', function()
            {
                  timeEnd = +d3.select(this).node().value;
                  timeMaxValue.innerHTML = timeEnd;
                  xScale.domain ([timeStart, timeEnd]);
   
                  // Update x-axis
                  svg.select ('.x.axis')
                     .transition ()
                     .duration (500)
                     .call (xAxis);

                  redrawGraph ();                            
            });
                     
        </script>

    </body>

</html>



